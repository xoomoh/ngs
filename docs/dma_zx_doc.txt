Вообще про ДМА

порты:
DMA_MOD - какой выбрать dma module
DMA_HAD - DMA High ADdress
DMA_MAD - Middle ADdress
DMA_LAD - Low ADdress
DMA_CST - Control and STate

Все регистры - на запись и на чтение, MOD, HAD, MAD и LAD - читают то, что
записано или новое состояние (адреса например инкрементируются иногда).

В DMA_MOD надо занести номер модуля (пока существует только модуль с номером 1)
и после чего станут доступны регистры этого модуля (остальные 4 порта)

HAD MAD и LAD - задают адрес (см. соответствие страниц и линейных адресов в доке
ngs_prm), адрес в ОЗУ, то есть дма из флешки невозможно.
После каждого обращения к ДМА со стороны спека адрес в этих ячейках
инкрементируется.

CST - содержит лишь один бит - старший, если он в 1 - дма для спека включено,
если в 0 - выключено. остальные биты не определены.



порядок работы

со стороны НГС: выбрать модуль (записав 1 в MOD), задать адрес начала (HAD MAD LAD),
включить DMA (7ой бит в CST в 1), по окончании дма - выключить 7ой бит в CST.

со стороны спектрума: когда НГС включит ДМА, читать байты из ПЗУ.

ВАЖНО! первый прочитанный байт - неверен! Правильный поток байтов пойдёт только
начиная со второго считанного байта. Это не значит, что адрес ДМА надо задавать на 1
меньше, чем нужно, адрес надо задавать ровно тот, что нужен. И второй байт придёт
как раз с заданного предвариетльно в HAD MAD LAD адреса. Третий - с этого адреса+1.
и так далее.

Другими словами, перед приёмом данных сделайте холостое чтение 1 байта из области
пзу и не парьтесь.

запись делается точно так же: надо писать в область пзу байты. В НГС они будут
писаться в его память начиная с указанного в адресных регистрах места.
При этом НЕ НУЖНО ДЕЛАТЬ ХОЛОСТУЮ ЗАПИСЬ В НАЧАЛЕ, в отличие от чтения. Cразу
пишите нужные данные.

Чтобы иметь возможность читать из дма (НГС подставляет свои данные), на спеке
надо включить ПЗУ в область 0000-3fff. Если там ОЗУ, нгс читать ничего не будет,
циклы дма генериться не будут (так как неактивен CSROM).
Чтобы же писать через ДМА, достаточно на спеке просто записать байт в область
0000-3fff, даже если там включено ОЗУ. Это стоит иметь в виду эмуляторщикам,
ибо тестовая прога так именно и пишет - в НГС и в ОЗУ, чтоб потом считать и
сравнить с тем, что в ОЗУ.

Тестовая прога включает ОЗУ в область 0000-3fff через порт 1ffd (каевский стандарт,
п14), соответственно для п22 ПРОГУ НАДО ИСПРАВИТЬ!
Прога мигает редко бордюром, перебирая все цвета - тест в процессе, всё нормально.
Прога рисует картинку на бордюре - ошибка. Выход - спаце.
Чтоб узнать адрес ошибки, поставьте брекпоинт на ld bc,#7ffe и запустите прогу.
при ошибке в де и хл будут адреса, можно посмотреть.

ВАЖНО! Перед загонянием флешером новой проши в НГС, ВЫКЛЮЧИТЕ ТУРБУ!
А то можете убить прошивку в флеше нах, и придётся колхозиться час через жтаг.


Рекомендации:
1. после включения дма прерывания (IM1) должны быть запрещены! А то спек уйдёт
на $38 а там ему говно из НГС польётся вместо родной пзушки...
2. если используете запись в порты НГС через штатную прошивку gs105a, то после
вкл.чения DMA (7ым битом в CST) сделайте паузу, скажем
ld b,0:djnz $:djnz $:djnz $:djnz $. Одного djnz $ редко, но не хватает (в турбе)
Как выяснилось, гс105а не сразу выполняет команду записи в порт, и если вы
начнёте хуячить ДМА сразу же, первые байты потеряются (при записи) или же
приедет содержимое ПЗУ. У меня терялся 1 байт в турбе, когда гс105а не играла
ничего, и до 15 байтов из пзу приходило, когда она играла мод.
3. НЕ ПЫТАЙТЕСЬ интерливить запись и чтение! Ничего хорошего не выйдет,
минимум позапишете говно в ОЗУ нгс, и получите кучу говна. Максимум, спектрум
зависнет от вечного ваита с НГС. лучше всего перед переходом с чтения на запись
(или наоборот) выключить ДМА и потом заново включить. Можно также устроить
большую паузу, вроде ld b,10:djnz $.
4. старайтесь работать на максимально возможной скорости процессора НГС.
Чем она больше, тем быстрее пройдёт ДМА (тем меньше ваитов).
И уж совершенно неприемлемо, если НГС будет работать медленнее, чем проц в спеке.
Например, если спек на 14мгц, а НГС на 12 - тогда ТОЧНО НИЧЕГО НЕ ЗАРАБОТАЕТ.



