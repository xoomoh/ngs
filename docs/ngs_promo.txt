Группа NedoPC рада представить вашему вниманию  траляля ВПИСАТЬ РЕКЛАМУ! :).
NeoGS (NGS)
old general sound (ogs)


Краткие технические характеристики:

 - полная программная совместимость с ogs
 - гибкая архитектура, основанная на fpga
 - 2 мегабайта RAM
 - 512 килобайт flash-ROM
 - расширенные способы адресации памяти: 2 окна проецирования, полное исключение ROM из адресного пространства
 - Z80 с переключаемой частотой (10, 12, 20 и 'турбо'-24 МГц)
 - 8 аппаратных звуковых каналов с громкостями (в 2 раза больше, чем у ogs)
 - mp3-декодер (аналог vs1001) с аппаратным SPI для пересылки данных
 - интерфейс SD-card с аппаратным SPI для пересылки данных.
 - DMA-доступ спектрума в память NGS (пересылка данных между спектрумом и NGS командами LDI, LDIR и подобными)
 - возможность полностью автономной работы (проигрывание модулей и mp3-файлов с SD-карточки по плейлисту, при этом
   сброс спектрума не влияет на NGS)

Звуковые возможности по сравнению с ogs значительно увеличены: теперь практически любой существующий 4-канальный
модуль поместится в памяти NGS. Расширенное число аппаратных каналов и увеличенная частота Z80 позволяют проигрывать как 8-канальные
модули, так и одновременно музыку и звуковые эффекты без отключения каналов музыки. mp3-декодер вместе с носителем
SD-card позволят вывести озвучку на качественно новый уровень. Наконец, NGS действительно (в отличие от ogs)
может работать как высокопроизводительный акселератор, имеющий широкий DMA-канал обмена данными со спектрумом.
Кроме того, DMA-канал позволяет значительно сократить времена загрузки звуковых данных в NGS.


Ниже приводится краткое описание дополнительных возможностей NGS с точки зрения программиста. При этом
предполагается, что читатель имеет ясное представление о архитектуре ogs.


Дешифрация портов со стороны спектрума, в отличие от ogs, выполнена по полному младшему байту адреса, при этом
сигнал IORQGE, опять же в отличие от ogs, выдаётся ТОЛЬКО на основе адреса и активен как при записи в порты, так
и при чтении из них.

Порты $B3 и $BB повторяют функциональность ogs.

В карту портов добавлен порт $33 с функцией сброса NGS и выдачи процессору NGS немаскируемого прерывания:
 при выводе в него числа $80 происходит сброс NGS. При выводе $40 - процессору NGS выдаётся NMI.



Внутренние порты NGS (перечислены только отличающиеся от портов ogs по функциональности, либо вновь добавленные):

$40-$FF - порты, использующиеся при начальной конфигурации FPGA, не должны использоваться при нормальной работе программ NGS.

порт $00, запись - адресация расширена до 2 мегабайт (биты 5..0: 64 страницы по 32 килобайта)

порт $0F, запись и чтение (того, что записано).

 bit 0 - NO ROM bit: 1 - подключена только RАМ,
                     0 - $4000-$7fff RАМ, остальное FLASH со страницами такими же как RAM.

 bit 1 - RAM RO bit: 1 - страница 0 RAM (абсолютные адреса 0..32767) защищена от записи (эмуляция ROM ogs)
                     0 - не защищена от записи.

 bit 2 - 8 channels bit: 1 - 8 звуковых каналов
                         0 - 4 канала (как в ogs).

 bit 3 - extended paging mode bit: 1 - расширенный режим страниц (см. ниже)
                                   0 - память переключается как в ogs

 bit 4,5 - z80 overclocking bits: 00 - Z80 работает на частоте 24МГц
                                  01 - Z80 работает на частоте 12МГц
                                  10 - Z80 работает на частоте 20МГц
                                  11 - Z80 работает на частоте 10МГц

 bits 6,7 - неиспользуемые: не определены при чтении, должны устанавливаться в ноль при записи


порт $10, запись. Расширенный порт страниц, используется, когда extended paging mode bit = 1

 Модель страниц в расширенном режиме такова:
 порт $00 - страница (16к кусок), включенная по адресам $8000-$bfff
 порт $10 - страница (16к кусок), включенная по адресам $c000-$ffff

Для 2 мегабайт памяти существует всего 128 страниц по 16 килобайт, пронумерованных числами от 0 до 127.

Имея номер такой страницы в A, делаем RRCA и выводим результат в порт $00 или $10, включая страницу с заданным номером
в соответствующее окно проецирования.


порты $16-$19, запись. Установка громкости в каналах 5-8

 Эти каналы существуют только в режиме, когда 8 channels bit = 1. В режиме 4 каналов
 при записи данных в каналы 1-4 эти данные автоматически копируются в каналы 5-8, т.о. громкость канала
 в 4-канальном режиме больше, чем в 8-канальном.


Как известно, в ogs запись отсчёта в ЦАП канала происходит чтением этого отсчёта из памяти:

 При чтении с адресов $6000-$60FF считанный байт идёт в ЦАП 1ого канала.
 При чтении с адресов $6100-$61FF - в ЦАП 2ого канала
 $6200-$62FF - 3его канала
 $6300-$63FF - 4ого канала
 $6400-$64FF - снова 1ого канала и так далее до $7F00-$7FFF - идёт в 4ый канал.

В 8-канальном режиме эта схема модифицируется очевидным образом:

 $60xx - 1ый
 $61xx - 2ой
 $62xx - 3
 $63xx - 4
 $64xx - 5
 $65xx - 6
 $66xx - 7
 $67xx - 8
 $68xx - 1
 и так далее до $7Fxx.

Распределение каналов по стереопанораме:

каналы 1,2,5,6 - левые
каналы 3,4,7,8 - правые



 MP3 и SD-card

Для связи с MP3-декодером (ma8201, аналог vs1001) используется
2 канала spi. Первый работает только на передачу, передаёт
непосредственно mp3-данные. Второй - управляющий, двунаправленный.

Для связи с SD-карточкой используется 1 spi-канал.

Передача байта осуществляется путём его записи в специальный порт передачи, ассоциированный
с данным SPI-каналом, что инициирует цикл обмена. Принятый в этом обмене байт (для двунаправленного
канала SPI) доступен в порте чтения. Кроме того, возможно чтение с перезапуском обмена (приём сектора из
SD-карточки будет выглядеть как INIR:INIR, передача - OTIR:OTIR).



 DMA

Со стороны спектрума DMA-канал с NGS выглядит как кусок памяти, подставляемый NGS вместо ПЗУ спектрума при
чтении или записи данных по адресам $0000-$3FFF при включённом ПЗУ (активен сигнал /CSROM на zx-bus).

Обмен происходит следующим образом:

На борту NGS есть адресный указатель, регистр чтения и регистр записи.
Если при включенном режиме DMA спектрум читает из области $0000-$3FFF
(конкретный адрес в этих пределах не имеет значения) при включенном ПЗУ, то происходит следующее:

1. ПЗУ блокируется сигналом RDROM zx-bus.
2. NGS выдаёт на ШД спектрума содержимое регистра чтения
3. NGS инициирует цикл DMA в собственную память выдачей /BUSRQ на процессор NGS; после получения /BUSAK на ША NGS выставляется
   содержимое адресного указателя и происходит чтение этого адреса, прочитанный байт сохраняется в регистре чтения, а адресный
   указатель инкрементируется.

процессы 1-2 и 3 идут параллельно таким образом, что спектрум принимает байт, считанный NGS из своей памяти в предыдущий цикл.
Однако если в момент чтения спектрумом байта NGS ещё не успел его прочитать из собственной памяти, то спектруму выставляется /WAIT.


При записи спектрумом в адреса $0000-$3FFF происходит следующее:

1. Записываемый байт сохраняется в регистре записи.
2. инициируется цикл DMA, в котором по адресу указателя записывается принятый со спектрума байт.

/WAIT аналогично выдаётся спектруму, если предыдущее значение регистра записи ещё не сохранено в памяти NGS.

При работе Z80 спектрума на частоте 3.5МГц, а NGS - на частоте 20 МГц /WAIT'ы выдаваться, как правило, не будут
при любой последовательности чтения или записи (в том числе через стек).




ОТМАЗКА (disclaimer по-английски который):
Вся приведённая информация является предварительной и может быть изменена без предупреждения.
Конечные спецификации будут доступны в комплекте документации, поставляемой с готовыми устройствами NGS.




(c) 2008 NedoPC

По всем вопросам, связанным с архитектурой NGS, пишите на lvd.mhm@gmail.com или lvd@dgap.mipt.ru

